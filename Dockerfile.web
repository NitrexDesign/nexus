FROM node:20-slim AS builder
WORKDIR /app
ARG BUILD_DATE
ENV BUILD_DATE=${BUILD_DATE:-unknown}
RUN corepack enable && corepack prepare pnpm@latest --activate
COPY web/package*.json ./
RUN pnpm install
COPY web/ ./
RUN pnpm next build

FROM node:20-slim
WORKDIR /app

# Create non-root user
RUN addgroup --gid 1001 nodejs && adduser --uid 1001 --gid 1001 --shell /bin/sh --disabled-login --disabled-password nextjs

COPY --from=builder --chown=1001:1001 /app/.next/standalone ./
COPY --from=builder --chown=1001:1001 /app/public ./public
COPY --from=builder --chown=1001:1001 /app/.next/static ./static

USER nextjs

ENV PORT=3000
ENV API_URL=http://server:8081

EXPOSE 3000

CMD ["node", "server.js"]
